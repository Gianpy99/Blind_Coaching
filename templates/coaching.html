<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blind Coaching Session - GROW Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #ffd4c4 0%, #ffb399 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        .section-title {
            font-size: 1.8rem;
            color: #d97742;
            margin-bottom: 20px;
            border-bottom: 3px solid #d97742;
            padding-bottom: 10px;
        }

        .question {
            margin-bottom: 20px;
        }

        .question-text {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .answer-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .answer-input:focus {
            outline: none;
            border-color: #d97742;
            box-shadow: 0 0 0 3px rgba(217, 119, 66, 0.15);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffc299 0%, #d97742 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(217, 119, 66, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #d97742;
            border: 2px solid #d97742;
        }

        .btn-secondary:hover {
            background: #d97742;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .completion-screen {
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 50px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .completion-screen h2 {
            color: #d97742;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .completion-screen p {
            font-size: 1.1rem;
            margin-bottom: 30px;
            color: #666;
        }

        .recap-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-left: 4px solid #d97742;
            border-radius: 5px;
        }

        .recap-item strong {
            color: #d97742;
        }

        #goalSummaryContent {
            max-height: 400px;
            overflow-y: auto;
        }

        .goal-reminder {
            background: linear-gradient(135deg, #ffc299 0%, #d97742 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(217, 119, 66, 0.2);
            animation: slideIn 0.5s ease-out;
        }

        .goal-reminder-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .goal-reminder-label {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
        }

        #goalReminderText {
            flex: 1;
            font-size: 1rem;
            line-height: 1.4;
            min-width: 200px;
        }

        .goal-reminder-edit {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .goal-reminder-edit:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Blind Coaching Session</h1>
            <p>GROW Model with SMART Goal Setting</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div id="coachingForm">
            <!-- Goal Reminder Banner -->
            <div id="goalReminder" class="goal-reminder hidden">
                <div class="goal-reminder-content">
                    <span class="goal-reminder-label">üéØ Your Goal:</span>
                    <span id="goalReminderText">Your goal statement will appear here</span>
                    <button class="goal-reminder-edit" onclick="editGoalStatement()">‚úèÔ∏è</button>
                </div>
            </div>

            {% for section in sections %}
            <div class="section {% if loop.index0 > 0 %}hidden{% endif %}" id="section-{{ loop.index0 }}">
                <h2 class="section-title">{{ section.title }}</h2>
                {% set outer_loop = loop %}
                {% for question in section.questions %}
                <div class="question">
                    <div class="question-text">{{ loop.index }}. {{ question }}</div>
                    <textarea 
                        class="answer-input" 
                        id="answer-{{ outer_loop.index0 }}-{{ loop.index0 }}"
                        placeholder="Take your time to reflect and write your answer here..."
                        data-section="{{ outer_loop.index0 }}"
                        data-question="{{ loop.index0 }}"
                    ></textarea>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Goal Recap Section -->
        <div id="goalRecap" class="section hidden">
            <h2 class="section-title">üéØ Your Goal Summary</h2>
            <p style="margin-bottom: 20px; color: #666; font-size: 1.1rem;">
                Before proceeding to assess your current reality, let's review the goal you've defined. 
                This is your opportunity to refine or clarify your objective.
            </p>
            
            <div id="goalSummaryContent" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <!-- Goal summary will be populated by JavaScript -->
            </div>
            
            <!-- Goal Statement Section -->
            <div style="background: linear-gradient(135deg, #ffc299 0%, #d97742 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h3 style="margin-bottom: 15px; color: white;">üìù Your Goal Statement</h3>
                <p style="margin-bottom: 10px; opacity: 0.9;">Summarize your goal using this format: <strong>"I will [Specific Goal] by [Timeframe]"</strong></p>
                <textarea 
                    id="goalStatement" 
                    placeholder="Format: I will [your specific goal] by [your timeframe].&#10;&#10;Example: I will increase my monthly revenue by 25% by the end of the next 6 months."
                    style="width: 100%; min-height: 80px; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; resize: vertical; font-family: inherit; line-height: 1.5;"
                ></textarea>
                <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">üí° This statement will appear at the top of each section as a reminder of your goal.</p>
            </div>
            
            <div style="margin-top: 25px;">
                <button class="btn btn-secondary" onclick="editGoal()" style="margin-right: 15px;">
                    ‚úèÔ∏è Edit Goal
                </button>
                <p style="margin-top: 15px; color: #666; font-style: italic;">
                    üí° Take a moment to reflect: Is this goal specific, measurable, achievable, relevant, and time-bound?
                </p>
            </div>
        </div>

        <div class="navigation">
            <button class="btn btn-secondary" id="prevBtn" onclick="changeSection(-1)" disabled>
                ‚Üê Previous
            </button>
            <span id="sectionIndicator">Section 1 of {{ sections|length }}</span>
            <button class="btn btn-primary" id="nextBtn" onclick="changeSection(1)">
                Next ‚Üí
            </button>
        </div>

        <div id="completionScreen" class="completion-screen hidden">
            <h2>üéâ Session Complete!</h2>
            <p>Congratulations! You've completed your coaching session using the GROW model.</p>
            <p>Review your answers and commit to your next steps.</p>
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="downloadReport()">
                    üìÑ Download Report
                </button>
                <button class="btn btn-secondary" onclick="startNewSession()" style="margin-left: 15px;">
                    üîÑ Start New Session
                </button>
            </div>
        </div>
    </div>

    <script>
        const sections = {{ sections | tojson }};
        let currentSection = 0;
        const totalSections = sections.length;

        function updateProgress() {
            const progress = ((currentSection + 1) / totalSections) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateNavigationForRecap() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const indicator = document.getElementById('sectionIndicator');

            prevBtn.disabled = false;
            nextBtn.textContent = 'Continue to Reality ‚Üí';
            indicator.textContent = 'Goal Summary & Review';
            
            // Update progress to show we're between Goal and Reality
            const progress = ((1.5) / totalSections) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateGoalRecap() {
            const goalSection = sections[0]; // Goal section
            let goalSummary = '';
            let combinedAnswers = '';
            
            goalSection.questions.forEach((question, questionIndex) => {
                const textarea = document.getElementById(`answer-0-${questionIndex}`);
                const answer = textarea ? textarea.value.trim() : '';
                if (answer) {
                    goalSummary += `<div class="recap-item">
                        <strong>Q:</strong> ${question}<br>
                        <strong>A:</strong> ${answer}
                    </div>`;
                    combinedAnswers += answer + ' ';
                }
            });

            if (!goalSummary) {
                goalSummary = '<p><em>No goals defined yet. Please go back and complete the Goal section.</em></p>';
            }

            document.getElementById('goalSummaryContent').innerHTML = goalSummary;
            
            // Auto-populate goal statement if empty
            const goalStatementField = document.getElementById('goalStatement');
            if (!goalStatementField.value.trim() && combinedAnswers.trim()) {
                // Create a suggested goal statement from the answers
                const suggestion = generateGoalSuggestion(combinedAnswers.trim());
                goalStatementField.value = suggestion;
            }
        }

        function generateGoalSuggestion(combinedAnswers) {
            // Extract specific answers from Goal section
            const goalSection = sections[0]; // Goal section
            let specific = '';
            let timeframe = '';
            
            // Get specific answers based on question patterns
            goalSection.questions.forEach((question, questionIndex) => {
                const textarea = document.getElementById(`answer-0-${questionIndex}`);
                const answer = textarea ? textarea.value.trim() : '';
                
                if (answer) {
                    // Check if it's the "What specifically" question (first question)
                    if (question.toLowerCase().includes('specifically') || question.toLowerCase().includes('what') && questionIndex === 0) {
                        specific = answer;
                    }
                    // Check if it's the timeframe question (last question or contains "when")
                    else if (question.toLowerCase().includes('when') || question.toLowerCase().includes('timeframe') || question.toLowerCase().includes('by when')) {
                        timeframe = answer;
                    }
                }
            });
            
            // Clean up the answers
            specific = specific.replace(/^(I want to|I will|I would like to|I plan to|My goal is to)\s*/i, '').trim();
            timeframe = timeframe.replace(/^(by|within|in|before)\s*/i, '').trim();
            
            // Create the formatted goal statement
            let goalStatement = '';
            
            if (specific && timeframe) {
                goalStatement = `I will ${specific} by ${timeframe}`;
            } else if (specific) {
                goalStatement = `I will ${specific}`;
            } else {
                // Fallback to combined answers if specific extraction fails
                goalStatement = combinedAnswers.replace(/\s+/g, ' ').trim();
                if (!goalStatement.toLowerCase().startsWith('i will')) {
                    goalStatement = 'I will ' + goalStatement.charAt(0).toLowerCase() + goalStatement.slice(1);
                }
            }
            
            // Ensure proper capitalization and punctuation
            goalStatement = goalStatement.charAt(0).toUpperCase() + goalStatement.slice(1);
            if (!goalStatement.endsWith('.')) {
                goalStatement += '.';
            }
            
            return goalStatement;
        }

        function updateGoalReminder() {
            const goalStatement = document.getElementById('goalStatement');
            const goalReminderText = document.getElementById('goalReminderText');
            const goalReminder = document.getElementById('goalReminder');
            
            if (goalStatement && goalStatement.value.trim()) {
                goalReminderText.textContent = goalStatement.value.trim();
                // Show reminder for sections after Goal (Reality, Options, Will)
                if (currentSection >= 1 && currentSection < totalSections) {
                    goalReminder.classList.remove('hidden');
                } else {
                    goalReminder.classList.add('hidden');
                }
            } else {
                goalReminder.classList.add('hidden');
            }
        }

        function editGoalStatement() {
            // Go back to goal recap to edit the statement
            currentSection = 0.5;
            showSection(currentSection);
            updateNavigationForRecap();
            
            // Focus on the goal statement field
            setTimeout(() => {
                document.getElementById('goalStatement').focus();
            }, 100);
        }

        function editGoal() {
            currentSection = 0;
            showSection(currentSection);
            updateNavigation();
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const indicator = document.getElementById('sectionIndicator');

            prevBtn.disabled = currentSection === 0;
            
            if (currentSection === totalSections - 1) {
                nextBtn.textContent = 'Complete Session ‚Üí';
            } else {
                nextBtn.textContent = 'Next ‚Üí';
            }

            indicator.textContent = `Section ${currentSection + 1} of ${totalSections}`;
            updateProgress();
        }

        function showSection(index) {
            // Hide all sections and recap
            for (let i = 0; i < totalSections; i++) {
                document.getElementById(`section-${i}`).classList.add('hidden');
            }
            document.getElementById('goalRecap').classList.add('hidden');
            
            // Show current section or goal recap
            if (index === 0.5) {
                // Show goal recap after Goal section
                document.getElementById('goalRecap').classList.remove('hidden');
                document.getElementById('coachingForm').classList.remove('hidden');
                document.getElementById('completionScreen').classList.add('hidden');
                updateGoalRecap();
            } else if (index < totalSections) {
                document.getElementById(`section-${index}`).classList.remove('hidden');
                document.getElementById('coachingForm').classList.remove('hidden');
                document.getElementById('completionScreen').classList.add('hidden');
            } else {
                // Show completion screen
                document.getElementById('coachingForm').classList.add('hidden');
                document.getElementById('completionScreen').classList.remove('hidden');
            }
            
            // Update goal reminder visibility
            updateGoalReminder();
        }

        function changeSection(direction) {
            if (direction === 1) {
                if (currentSection === 0) {
                    // After Goal section, show Goal Recap
                    currentSection = 0.5;
                    showSection(currentSection);
                    updateNavigationForRecap();
                    return;
                } else if (currentSection === 0.5) {
                    // After Goal Recap, go to Reality section
                    currentSection = 1;
                    showSection(currentSection);
                    updateNavigation();
                    return;
                } else if (currentSection === totalSections - 1) {
                    // Complete session
                    currentSection = totalSections;
                    showSection(currentSection);
                    document.querySelector('.navigation').style.display = 'none';
                    return;
                }
            } else if (direction === -1) {
                if (currentSection === 0.5) {
                    // From Goal Recap back to Goal section
                    currentSection = 0;
                    showSection(currentSection);
                    updateNavigation();
                    return;
                } else if (currentSection === 1) {
                    // From Reality back to Goal Recap
                    currentSection = 0.5;
                    showSection(currentSection);
                    updateNavigationForRecap();
                    return;
                }
            }

            const newSection = currentSection + direction;
            if (newSection >= 0 && newSection < totalSections) {
                currentSection = newSection;
                showSection(currentSection);
                updateNavigation();
            }
        }

        function debugTextareas() {
            console.log('=== DEBUG: Checking all textareas ===');
            const allTextareas = document.querySelectorAll('.answer-input');
            allTextareas.forEach(textarea => {
                console.log(`ID: ${textarea.id}, Value: "${textarea.value}"`);
            });
            
            console.log('=== DEBUG: Expected IDs based on sections ===');
            sections.forEach((section, sectionIndex) => {
                section.questions.forEach((question, questionIndex) => {
                    const expectedId = `answer-${sectionIndex}-${questionIndex}`;
                    const element = document.getElementById(expectedId);
                    console.log(`Expected: ${expectedId}, Found: ${element ? 'YES' : 'NO'}`);
                });
            });
        }

        function collectAnswers() {
            const sessionData = {
                goalStatement: '',
                sections: []
            };

            // Collect goal statement
            const goalStatementField = document.getElementById('goalStatement');
            if (goalStatementField) {
                sessionData.goalStatement = goalStatementField.value.trim();
            }

            sections.forEach((section, sectionIndex) => {
                const sectionData = {
                    title: section.title,
                    answers: []
                };

                section.questions.forEach((question, questionIndex) => {
                    // Fix the ID selector to match the actual HTML structure
                    const textarea = document.getElementById(`answer-${sectionIndex}-${questionIndex}`);
                    if (textarea) {
                        sectionData.answers.push({
                            question: question,
                            answer: textarea.value || ''
                        });
                    } else {
                        console.error(`Textarea not found: answer-${sectionIndex}-${questionIndex}`);
                        sectionData.answers.push({
                            question: question,
                            answer: ''
                        });
                    }
                });

                sessionData.sections.push(sectionData);
            });

            console.log('Collected session data:', sessionData);
            return sessionData;
        }

        function downloadReport() {
            const sessionData = collectAnswers();
            
            // Check if there are any answers
            const hasAnswers = sessionData.sections.some(section => 
                section.answers.some(qa => qa.answer.trim() !== '')
            );
            
            if (!hasAnswers) {
                alert('Please answer at least one question before downloading the report.');
                return;
            }
            
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/download_direct';
            form.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'session_data';
            input.value = JSON.stringify(sessionData);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function testDownload() {
            // Create test data
            const testData = {
                sections: [
                    {
                        title: "Test Section",
                        answers: [
                            { question: "Test Question 1", answer: "Test Answer 1" },
                            { question: "Test Question 2", answer: "Test Answer 2" }
                        ]
                    }
                ]
            };
            
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/download_direct';
            form.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'session_data';
            input.value = JSON.stringify(testData);
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function startNewSession() {
            // Clear all answers
            document.querySelectorAll('.answer-input').forEach(textarea => {
                textarea.value = '';
            });
            
            // Reset to first section
            currentSection = 0;
            showSection(currentSection);
            updateNavigation();
            document.querySelector('.navigation').style.display = 'flex';
            
            // Clear goal recap
            document.getElementById('goalSummaryContent').innerHTML = '';
        }

        // Initialize
        updateNavigation();
        updateProgress();
        
        // Add event listener for goal statement changes
        document.addEventListener('DOMContentLoaded', function() {
            const goalStatement = document.getElementById('goalStatement');
            if (goalStatement) {
                goalStatement.addEventListener('input', updateGoalReminder);
                goalStatement.addEventListener('blur', updateGoalReminder);
            }
        });
    </script>
</body>
</html>
